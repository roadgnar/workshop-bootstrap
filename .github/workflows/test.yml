name: Test Bootstrap

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  # ============================================
  # Linux Testing
  # ============================================
  test-linux:
    name: üêß Linux (Ubuntu)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x linux/bootstrap linux/dev
          chmod +x scripts/*.sh

      - name: Verify Docker is available
        run: |
          docker --version
          docker compose version

      - name: Test bootstrap (skip installs, Docker pre-installed)
        run: |
          cd linux
          
          # Source the common script to test detection logic
          export OS="linux"
          export SCRIPT_DIR="$(cd .. && pwd)"
          source ../scripts/utils.sh
          
          echo "==> Testing detection functions..."
          
          if docker_installed; then
            echo "‚úì Docker detected"
          else
            echo "‚úó Docker not detected"
            exit 1
          fi
          
          if docker_running; then
            echo "‚úì Docker daemon running"
          else
            echo "‚úó Docker daemon not running"
            exit 1
          fi
          
          if compose_available; then
            echo "‚úì Docker Compose available"
          else
            echo "‚úó Docker Compose not available"
            exit 1
          fi

      - name: Build container
        run: |
          docker compose build dev

      - name: Start container
        run: |
          docker compose up -d dev
          sleep 5
          docker compose ps

      - name: Start demo service
        run: |
          docker compose exec -d dev bash -c "cd /workspace/demo-site && python app.py"
          sleep 5

      - name: Test demo endpoints
        run: |
          echo "==> Testing health endpoint..."
          curl -sf http://localhost:8080/health | jq .
          
          echo "==> Testing main page..."
          curl -sf http://localhost:8080 | head -20
          
          echo "==> Testing API info..."
          curl -sf http://localhost:8080/api/info | jq .

      - name: Test dev helper commands
        run: |
          cd linux
          ./dev status
          ./dev logs &
          sleep 2
          kill %1 || true

      - name: Cleanup
        if: always()
        run: |
          docker compose down --volumes --remove-orphans || true

  # ============================================
  # macOS Testing
  # ============================================
  test-macos:
    name: üçé macOS
    runs-on: macos-15  
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x mac/bootstrap mac/dev
          chmod +x scripts/*.sh

      - name: Setup Docker
        uses: docker/setup-docker-action@v4

      - name: Verify Docker is available
        run: |
          docker --version
          docker compose version

      - name: Test bootstrap detection logic
        run: |
          cd mac
          
          export OS="macos"
          export SCRIPT_DIR="$(cd .. && pwd)"
          source ../scripts/utils.sh
          
          echo "==> Testing detection functions..."
          
          if docker_installed; then
            echo "‚úì Docker detected"
          else
            echo "‚úó Docker not detected"
            exit 1
          fi
          
          if docker_running; then
            echo "‚úì Docker daemon running"
          else
            echo "‚úó Docker daemon not running"
            exit 1
          fi

      - name: Build container
        run: |
          docker compose build dev

      - name: Start container
        run: |
          docker compose up -d dev
          sleep 5
          docker compose ps

      - name: Start demo service
        run: |
          docker compose exec -d dev bash -c "cd /workspace/demo-site && python app.py"
          sleep 5

      - name: Test demo endpoints
        run: |
          echo "==> Testing health endpoint..."
          curl -sf http://localhost:8080/health
          
          echo "==> Testing main page..."
          curl -sf http://localhost:8080 | head -20
          
          echo "==> Testing API info..."
          curl -sf http://localhost:8080/api/info

      - name: Cleanup
        if: always()
        run: |
          docker compose down --volumes --remove-orphans || true

  # ============================================
  # Windows Testing
  # ============================================
  # Note: Windows GitHub Actions runners use Windows containers by default.
  # Our Dockerfile is Linux-based, so we test scripts only here.
  # Container functionality is verified on Linux/macOS runners.
  test-windows:
    name: ü™ü Windows (Scripts Only)
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test PowerShell utilities
        shell: pwsh
        run: |
          . .\scripts\utils.ps1
          
          Write-Banner
          Write-Step "Testing utility functions..."
          Write-Info "Info message test"
          Write-Success "Success message test"
          Write-Warn "Warning message test"
          Write-Separator

      - name: Test detection functions
        shell: pwsh
        run: |
          . .\scripts\utils.ps1
          
          Write-Step "Testing detection functions..."
          
          # Test command existence check
          if (Test-CommandExists "powershell") {
            Write-Success "Test-CommandExists works"
          } else {
            Write-Error "Test-CommandExists failed"
            exit 1
          }
          
          # Test Docker detection (may or may not be installed)
          Write-Info "Docker installed: $(Test-DockerInstalled)"
          Write-Info "Docker running: $(Test-DockerRunning)"
          Write-Info "Compose available: $(Test-ComposeAvailable)"

      - name: Test bootstrap script syntax
        shell: pwsh
        run: |
          Write-Host "==> Checking bootstrap.ps1 syntax..."
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content -Path ".\windows\bootstrap.ps1" -Raw), 
            [ref]$null
          )
          Write-Host "‚úì bootstrap.ps1 syntax OK"
          
          Write-Host "==> Checking dev.ps1 syntax..."
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content -Path ".\windows\dev.ps1" -Raw), 
            [ref]$null
          )
          Write-Host "‚úì dev.ps1 syntax OK"

      - name: Test installer script syntax
        shell: pwsh
        run: |
          Write-Host "==> Checking install-docker-windows.ps1 syntax..."
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content -Path ".\scripts\install-docker-windows.ps1" -Raw), 
            [ref]$null
          )
          Write-Host "‚úì install-docker-windows.ps1 syntax OK"
          
          Write-Host "==> Checking install-cursor-windows.ps1 syntax..."
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content -Path ".\scripts\install-cursor-windows.ps1" -Raw), 
            [ref]$null
          )
          Write-Host "‚úì install-cursor-windows.ps1 syntax OK"

      - name: Test dev.ps1 help
        shell: pwsh
        run: |
          cd windows
          .\dev.ps1 help

  # ============================================
  # Summary Job
  # ============================================
  test-summary:
    name: ‚úÖ All Tests Passed
    needs: [test-linux, test-macos, test-windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.test-linux.result }}" != "success" ]; then
            echo "‚ùå Linux tests failed"
            exit 1
          fi
          if [ "${{ needs.test-macos.result }}" != "success" ]; then
            echo "‚ùå macOS tests failed"
            exit 1
          fi
          if [ "${{ needs.test-windows.result }}" != "success" ]; then
            echo "‚ùå Windows tests failed"
            exit 1
          fi
          echo "‚úÖ All platform tests passed!"

